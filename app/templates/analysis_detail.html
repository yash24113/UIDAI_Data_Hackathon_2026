{% extends "base.html" %}

{% block filters %}
<div class="nav-filters w-100 w-sm-auto">
    <select class="form-select form-select-sm" id="stateFilter">
        <option value="All">All States</option>
        {% for state in states %}
        <option value="{{ state }}">{{ state }}</option>
        {% endfor %}
    </select>
    <select class="form-select form-select-sm" id="districtFilter">
        <option value="All">All Districts</option>
    </select>
</div>
{% endblock %}

{% block content %}
<div class="row align-items-center mb-4 g-3">
    <div class="col-12 col-lg-7">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Idea {{ idea_id }}</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-0">{{ title }}</h2>
    </div>
    <div class="col-12 col-lg-5 d-flex gap-2 justify-content-lg-end no-print">
        <a href="#" id="exportCsvBtn" class="btn btn-outline-success flex-fill flex-lg-grow-0">
            <i class="fas fa-file-csv me-1"></i> CSV
        </a>
        <button onclick="window.print()" class="btn btn-dark flex-fill flex-lg-grow-0">
            <i class="fas fa-print me-1"></i> Print / Save as PDF
        </button>
        <a href="#" id="exportPdfBtn" class="btn btn-danger flex-fill flex-lg-grow-0">
            <i class="fas fa-file-pdf me-1"></i> Text Report
        </a>
    </div>
</div>
<style>
    @media print {
        body {
            background: white;
        }

        .no-print,
        .navbar,
        .sidebar-link,
        footer,
        #sidebar-wrapper {
            display: none !important;
        }

        #wrapper.toggled #page-content-wrapper {
            margin-left: 0;
        }

        #page-content-wrapper {
            margin: 0 !important;
            width: 100%;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        /* Ensure charts print clearly */
        canvas {
            max-height: 500px !important;
            width: 100% !important;
        }
    }
</style>

<div class="row g-4">
    <!-- Main Chart -->
    <div class="col-12 col-xl-8">
        <div class="card shadow-sm border-0 h-100 p-2 p-md-3">
            <div class="card-body">
                <h5 class="card-title text-muted mb-4 small text-uppercase fw-bold">Statistical Visualization</h5>
                <div style="height: 400px; position: relative;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="col-12 col-xl-4">
        <div class="row g-4 h-100">
            <div class="col-12">
                <div class="card bg-white shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="text-uppercase text-danger fw-bold small mb-2"><i
                                    class="fas fa-exclamation-circle me-1"></i> Problem</h6>
                            <p id="problemText" class="text-dark small lh-base">Loading...</p>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-uppercase text-primary fw-bold small mb-2"><i
                                    class="fas fa-lightbulb me-1"></i> Key Insight</h6>
                            <p id="insightText" class="fw-bold text-dark small">Loading...</p>
                        </div>

                        <div class="mb-0">
                            <h6 class="text-uppercase text-success fw-bold small mb-2"><i
                                    class="fas fa-check-circle me-1"></i> Government Recommended Solution</h6>
                            <p id="solutionText" class="text-dark small lh-base">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Preview -->
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">Tabular Data Preview (Top 15)</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="dataTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="px-4 py-3 border-0">Region / Category</th>
                                <th class="px-4 py-3 border-0 text-end">Metric Value</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const ideaId = parseInt("{{ idea_id }}");
    let myChart = null;
    let currentData = null; // Store data for re-rendering insight

    const ideaTranslations = {
        1: {
            'en': {
                'problem': 'Uneven distribution of Aadhaar services leads to resource mismanagement and long wait times for citizens.',
                'solution': 'Strategically deploy mobile Aadhaar vans and increase operator strength in identified high-activity districts to ensure 100% service coverage.'
            },
            'hi': {
                'problem': 'आधार सेवाओं का असमान वितरण संसाधनों के कुप्रबंधन और नागरिकों के लिए लंबे इंतजार के समय का कारण बनता है।',
                'solution': 'पहचाने गए उच्च-गतिविधि वाले जिलों में मोबाइल आधार वैन और ऑपरेटर क्षमता को रणनीतिक रूप से तैनात करें ताकि 100% सेवा कवरेज सुनिश्चित हो सके।'
            },
            'gu': {
                'problem': 'આધાર સેવાઓનું વિતરણ અસમાન હોવાથી સંસાધનોનું ગેરવહીવટ થાય છે અને નાગરિકોને લાંબો સમય રાહ જોવી પડે છે.',
                'solution': '100% સેવા કવરેજ સુનિશ્ચિત કરવા માટે ઓળખાયેલ ઉચ્ચ-પ્રવૃત્તિ ધરાવતા જિલ્લાઓમાં મોબાઈલ આધાર વાન અને ઓપરેટરની સંખ્યા વ્યૂહાત્મક રીતે વધારવી.'
            }
        },
        2: {
            'en': {
                'problem': 'Citizens in specific areas are failing to update biometrics, leading to authentication failures in welfare schemes.',
                'solution': 'Mandatory Biometric Update Camps to be organized in the identified districts, synchronized with local fair-price shops and schools.'
            },
            'hi': {
                'problem': 'विशिष्ट क्षेत्रों में नागरिक बायोमेट्रिक्स अपडेट करने में विफल हो रहे हैं, जिससे कल्याणकारी योजनाओं में प्रमाणीकरण विफल हो रहा है।',
                'solution': 'पहचाने गए जिलों में अनिवार्य बायोमेट्रिक अपडेट कैंप आयोजित किए जाएं, जो स्थानीय उचित मूल्य की दुकानों और स्कूलों के साथ समन्वयित हों।'
            },
            'gu': {
                'problem': 'ચોક્કસ વિસ્તારોમાં નાગરિકો બાયોમેટ્રિક્સ અપડેટ કરવામાં નિષ્ફળ રહ્યા છે, જેના કારણે કલ્યાણકારી યોજનાઓમાં પ્રમાણીકરણ નિષ્ફળ જાય છે.',
                'solution': 'ઓળખાયેલ જિલ્લાઓમાં ફરજિયાત બાયોમેટ્રિક અપડેટ કેમ્પનું આયોજન કરવું, જે સ્થાનિક વ્યાજબી ભાવની દુકાનો અને શાળાઓ સાથે સંકલિત હોય.'
            }
        },
        3: {
            'en': { 'problem': 'Requirement for secure, privacy-preserving age verification for first-time voters.', 'solution': 'Implementation of ZKP-based age verification APIs for the Election Commission.' },
            'hi': { 'problem': 'पहली बार मतदाताओं के लिए सुरक्षित, गोपनीयता-संरक्षित आयु सत्यापन की आवश्यकता।', 'solution': 'चुनाव आयोग के लिए ZKP-आधारित आयु सत्यापन API का कार्यान्वयन।' },
            'gu': { 'problem': 'પ્રથમ વખત મતદાન કરનારાઓ માટે સુરક્ષિત, ગોપનીયતા-સાચવતી ઉંમર ચકાસણીની જરૂરિયાત.', 'solution': 'ચૂંટણી પંચ માટે ZKP-આધારિત ઉંમર ચકાસણી API નો અમલ.' }
        },
        4: {
            'en': { 'problem': 'Low child enrollment (0-5 years) indicates potential gaps in birth-registration-linked Aadhaar saturation.', 'solution': 'Integration of Aadhaar enrollment with the Mother and Child Tracking System (MCTS).' },
            'hi': { 'problem': 'कम बाल नामांकन (0-5 वर्ष) जन्म-पंजीकरण से जुड़े आधार संतृप्ति में संभावित अंतराल का संकेत देता है।', 'solution': 'मातृ एवं शिशु ट्रैकिंग प्रणाली (MCTS) के साथ आधार नामांकन का एकीकरण।' },
            'gu': { 'problem': 'ઓછું બાળ નોંધણી (0-5 વર્ષ) જન્મ-નોંધણી સાથે સંકળાયેલ આધાર સંતૃપ્તિમાં સંભવિત તફાવત સૂચવે છે.', 'solution': 'માતા અને બાળ ટ્રેકિંગ સિસ્ટમ (MCTS) સાથે આધાર નોંધણીનું સંકલન.' }
        },
        5: {
            'en': { 'problem': 'Unusual spikes in demographic updates might signal systematic data manipulation.', 'solution': 'Immediate automated audit of service centers in high-spike pincodes.' },
            'hi': { 'problem': 'जनसांख्यिकीय अपडेट में असामान्य वृद्धि व्यवस्थित डेटा हेरफेर का संकेत दे सकती है।', 'solution': 'उच्च-वृद्धि वाले पिनकोड में सेवा केंद्रों का तत्काल स्वचालित ऑडिट।' },
            'gu': { 'problem': 'વસ્તી વિષયક અપડેટ્સમાં અસામાન્ય વધારો વ્યવસ્થિત ડેટા ચેડાનો સંકેત આપી શકે છે.', 'solution': 'ઉચ્ચ-સ્પાઇક પિનકોડ્સમાં સેવા કેન્દ્રોનું તાત્કાલિક સ્વચાલિત ઓડિટ.' }
        },
        6: {
            'en': { 'problem': 'Gaps in digital facility updates hinder the transition to a DBT enabled economy.', 'solution': 'Link Aadhaar update frequency with Jan Dhan account activity.' },
            'hi': { 'problem': 'डिजिटल सुविधा अपडेट में अंतराल डीबीटी सक्षम अर्थव्यवस्था में संक्रमण में बाधा डालता है।', 'solution': 'जन धन खाता गतिविधि के साथ आधार अपडेट आवृत्ति को लिंक करें।' },
            'gu': { 'problem': 'ડિજિટલ સુવિધા અપડેટ્સમાં તફાવત DBT સક્ષમ અર્થતંત્રમાં સંક્રમણને અવરોધે છે.', 'solution': 'જન ધન ખાતાની પ્રવૃત્તિ સાથે આધાર અપડેટ આવર્તનને લિંક કરો.' }
        },
        7: {
            'en': { 'problem': 'High enrollment states often face language barriers, leading to data entry errors.', 'solution': 'Mandatory deployment of multi-lingual support interfaces and local language translators.' },
            'hi': { 'problem': 'उच्च नामांकन वाले राज्यों को अक्सर भाषा की बाधाओं का सामना करना पड़ता है, जिससे डेटा प्रविष्टि त्रुटियां होती हैं।', 'solution': 'बहु-भाषी समर्थन इंटरफेस और स्थानीय भाषा अनुवादकों की अनिवार्य तैनाती।' },
            'gu': { 'problem': 'ઉચ્ચ નોંધણી ધરાવતા રાજ્યોને ઘણીવાર ભાષાના અવરોધોનો સામનો કરવો પડે છે, જેના કારણે ડેટા એન્ટ્રી ભૂલો થાય છે.', 'solution': 'બહુ-ભાષી સપોર્ટ ઇન્ટરફેસ અને સ્થાનિક ભાષા અનુવાદકોની ફરજિયાત જમાવટ.' }
        },
        8: {
            'en': { 'problem': 'Persistent demographic updates with zero biometric updates indicate faulty scanners.', 'solution': 'Real-time hardware health monitoring dashboard and automatic ticket generation.' },
            'hi': { 'problem': 'शून्य बायोमेट्रिक अपडेट के साथ लगातार जनसांख्यिकीय अपडेट दोषपूर्ण स्कैनर का संकेत देते हैं।', 'solution': 'वास्तविक समय हार्डवेयर स्वास्थ्य निगरानी डैशबोर्ड और स्वचालित टिकट निर्माण।' },
            'gu': { 'problem': 'શૂન્ય બાયોમેટ્રિક અપડેટ્સ સાથે સતત વસ્તી વિષયક અપડેટ્સ ખામીયુક્ત સ્કેનર્સ સૂચવે છે.', 'solution': 'રીઅલ-ટાઇમ હાર્ડવેર હેલ્થ મોનિટરિંગ ડેશબોર્ડ અને ઓટોમેટિક ટિકિટ જનરેશન.' }
        },
        9: {
            'en': { 'problem': 'Lack of real-time data on population displacement during natural disasters.', 'solution': 'Utilize demographic update spikes as a proxy for migration tracking.' },
            'hi': { 'problem': 'प्राकृतिक आपदाओं के दौरान जनसंख्या विस्थापन पर वास्तविक समय के आंकड़ों की कमी।', 'solution': 'प्रवास ट्रैकिंग के लिए प्रॉक्सी के रूप में जनसांख्यिकीय अपडेट स्पाइक्स का उपयोग करें।' },
            'gu': { 'problem': 'કુદરતી આફતો દરમિયાન વસ્તી વિસ્થાપન પર વાસ્તવિક સમયના ડેટાનો અભાવ.', 'solution': 'સ્થળાંતર ટ્રેકિંગ માટે પ્રોક્સી તરીકે વસ્તી વિષયક અપડેટ સ્પાઇક્સનો ઉપયોગ કરો.' }
        },
        10: {
            'en': { 'problem': 'Extreme overcrowding at urban Aadhaar Seva Kendras leads to citizen dissatisfaction.', 'solution': 'Smart Appointment Scheduling and extended shift timings.' },
            'hi': { 'problem': 'शहरी आधार सेवा केंद्रों पर अत्यधिक भीड़भाड़ से नागरिकों में असंतोष होता है।', 'solution': 'स्मार्ट अपॉइंटमेंट शेड्यूलिंग और विस्तारित शिफ्ट समय।' },
            'gu': { 'problem': 'શહેરી આધાર સેવા કેન્દ્રો પર ભારે ભીડ નાગરિકોમાં અસંતોષ તરફ દોરી જાય છે.', 'solution': 'સ્માર્ટ એપોઇન્ટમેન્ટ શેડ્યૂલિંગ અને વિસ્તૃત શિફ્ટ સમય.' }
        }
    };

    function generateDynamicInsight(data, lang) {
        if (!data || !data.labels || data.labels.length === 0) return "";

        const labels = data.labels;
        const values = data.data;

        // Find Index of High and Low
        let maxIndex = 0;
        let minIndex = 0;
        for (let i = 1; i < values.length; i++) {
            if (values[i] > values[maxIndex]) maxIndex = i;
            if (values[i] < values[minIndex]) minIndex = i;
        }

        const highName = getStateTrans(labels[maxIndex]); // Use base.html helper
        const lowName = getStateTrans(labels[minIndex]);
        const highVal = formatNumber(values[maxIndex]); // Use base.html helper
        const lowVal = formatNumber(values[minIndex]);

        let template = "";

        if (lang === 'hi') {
            template = `<strong>${highName}</strong> सबसे अधिक मात्रा (${highVal}) रिपोर्ट करता है। इसके विपरीत, <strong>${lowName}</strong> सबसे कम (${lowVal}) है। यह असमानता संसाधनों के आवंटन में अंतर का सुझाव देती है।`;
        } else if (lang === 'gu') {
            template = `<strong>${highName}</strong> સૌથી વધુ જથ્થો (${highVal}) ધરાવે છે. તેનાથી વિપરીત, <strong>${lowName}</strong> સૌથી ઓછું (${lowVal}) છે. આ તફાવત સંસાધનોની ફાળવણીમાં અસમાનતા સૂચવે છે.`;
        } else {
            // Default English fallback if Python extraction failed or just consistency
            template = `<strong>${highName}</strong> reports the highest volume (${highVal}). In contrast, <strong>${lowName}</strong> reports the lowest (${lowVal}). This disparity suggests uneven resource allocation.`;
        }
        return template;
    }

    function updateContent(lang) {
        // Problem & Solution
        const content = ideaTranslations[ideaId];
        if (content) {
            const t = content[lang] || content['en'];
            document.getElementById('problemText').innerText = t.problem;
            document.getElementById('solutionText').innerText = t.solution;
        }

        // Dynamic Insight
        if (currentData) {
            const insight = generateDynamicInsight(currentData, lang);
            const prefix = getTrans('insight'); // base.html helper
            document.getElementById('insightText').innerHTML = `${insight}`; // Prefix is in chart logic usually, but here separate

            // Allow update of table if necessary (labels)
            updateTable(currentData, lang);
        }
    }

    function updateTable(data, lang) {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        const limit = Math.min(data.labels.length, 15);
        for (let i = 0; i < limit; i++) {
            const row = `<tr>
                 <td class="px-4 py-3 border-bottom-0 fw-medium">${getStateTrans(data.labels[i])}</td>
                 <td class="px-4 py-3 border-bottom-0 text-end fw-bold text-primary">${formatNumber(data.data[i])}</td>
             </tr>`;
            tbody.innerHTML += row;
        }
    }

    // Language Change Listener
    window.addEventListener('languageChanged', (e) => {
        updateContent(e.detail.lang);
        if (myChart) myChart.destroy(); // Optional: Re-render chart if needed for legends
        initChart(currentData.labels, currentData.data); // Re-init to use localized State names if mapped
    });

    function initChart(labels, data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();

        // Localize Labels for Chart
        const localizedLabels = labels.map(l => getStateTrans(l));

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: localizedLabels,
                datasets: [{
                    label: getTrans('chart_activity') || 'Count / Ratio',
                    data: data,
                    backgroundColor: 'rgba(13, 110, 253, 0.7)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return formatNumber(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { font: { size: 10 } } },
                    y: { beginAtZero: true, grid: { drawBorder: false } }
                }
            }
        });
    }

    function loadData() {
        showLoader();
        const state = document.getElementById('stateFilter').value;
        const district = document.getElementById('districtFilter').value;
        const params = `?state=${state}&district=${district}`;

        // Update Export Links
        document.getElementById('exportPdfBtn').href = `/export/idea/${ideaId}${params}`;
        document.getElementById('exportCsvBtn').href = `/export/idea/csv/${ideaId}${params}`;

        fetch(`/api/data/idea/${ideaId}${params}`)
            .then(r => r.json())
            .then(data => {
                currentData = data; // Store for switching

                // Init with current language
                const lang = document.getElementById('languageSelect').value || 'en';
                updateContent(lang);
                initChart(data.labels, data.data);

                hideLoader();
            })
            .catch(() => hideLoader());
    }

    // Filter Logic
    document.getElementById('stateFilter').addEventListener('change', function () {
        const state = this.value;
        const districtSelect = document.getElementById('districtFilter');
        districtSelect.innerHTML = '<option value="All">Loading...</option>';

        if (state !== "All") {
            fetch(`/api/districts/${state}`).then(r => r.json()).then(data => {
                districtSelect.innerHTML = '<option value="All">All Districts</option>';
                data.forEach(d => {
                    districtSelect.innerHTML += `<option value="${d}">${d}</option>`;
                });
                loadData();
            });
        } else {
            districtSelect.innerHTML = '<option value="All">All Districts</option>';
            loadData();
        }
    });

    document.getElementById('districtFilter').addEventListener('change', loadData);

    document.addEventListener("DOMContentLoaded", loadData);
</script>
{% endblock %}